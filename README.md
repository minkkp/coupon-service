# 선착순 쿠폰 발급 시스템

Redis와 Lua를 활용해  
대규모 요청 환경에서 한정 수량의 쿠폰을 정확하게 발급하고,
장애 대응까지 고려한 토이 프로젝트입니다.

---
## 🛠️ 기술 스택

- Java, Spring Boot, JPA, Redis, PostgreSQL

---
## 📌 프로젝트 목적

- 대규모 트래픽 환경에서 한정 수량 쿠폰을 정확하게 발급
- 트래픽 증가, Redis 장애, 운영 복구까지 고려한 설계 경험
- 쿠폰 과발급 / 중복 발급 방지
---

## 🧠 핵심 설계 요약

- Redis + Lua 기반 선착순 제어 (원자 처리)  
  → 단일 Redis 연산으로 동시성 환경에서도 race condition 방지
- 쿠폰 발급 처리와 이력 저장을 분리하여 병목 제거
- Redis 장애 시 Fail-Fast 전략 적용  
  → 대체 처리 없이 즉시 실패 처리하여 정합성 유지  
  → DB에 저장된 발급 이력을 기준으로 Redis 재고를 다시 맞추는 동기화 API 제공
- 이벤트 종료 시 Redis 키를 즉시 삭제하고, 누락을 대비해 만료 시간(TTL)도 함께 설정

---

## 🏗️ 아키텍처 개요

- **Redis**
  - 쿠폰 재고 및 사용자 요청 관리
  - Lua 스크립트로 사용자 요청 체크 + 쿠폰 재고 감소를 단일 연산으로 처리
    
- **DB**
  - 발급 성공시 이력을 비동기로 저장

- **Application**
  - 쿠폰 발급 흐름 오케스트레이션
  - 이벤트 생명주기(open / close / sync) 관리

---

## 🧩 핵심 코드 구성

- CouponFacadeService  
  → 쿠폰 발급 전체 흐름 오케스트레이션

- RedisCouponService  
  → Redis + Lua 기반 쿠폰 발급 제어

- EventService  
  → 이벤트 생명주기 및 운영(open / close / sync) 관리

- AsyncCouponIssueService  
  → 발급 이력을 비동기 DB 저장

---

## 🔄 쿠폰 발급 흐름

1. 이벤트 상태 및 기간 검증 (DB)
2. Redis + Lua를 통한 선착순 발급 처리
   - 중복 참여 체크
   - 한정 수량 재고 확인 및 감소
3. 발급 성공 시에만 DB에 비동기 이력 저장
4. 즉시 응답 반환

---

## 🚨 장애 · 이슈 대응

### Redis 장애
- Redis 오류 발생 시 즉시 실패 응답 (Fail-Fast)
- 불완전한 발급을 방지하기 위해 fallback 없이 처리

### DB 비동기 저장 실패시
- 발급 결과에는 영향 없음
- 운영자가 동기화 API 호출하여 DB를 기준(Source of Truth)으로 Redis 재고 복구

### 이벤트 종료 처리
- 이벤트 종료 시 Redis 키 즉시 제거
- TTL을 사용하여 이벤트 종료 시간 기준으로 Redis 키를 제거하여 2차 안전장치 제공

---

## 🗂️ ERD

본 프로젝트에서는 발급 성능과 정합성을 우선시하여  
쿠폰 발급 흐름에 직접적으로 필요한 테이블만 최소한으로 설계

- 사용자(User) 정보는 발급 로직에 직접 사용하지 않아  
  쿠폰 발급 도메인과 연관관계를 맺지 않음
- 이벤트(Event)는 발급 조건(기간, 수량)을 관리하는 기준 엔티티
- 쿠폰(Coupon)은 이벤트를 통해 발급되는 혜택 정보
- 쿠폰 발급 여부 판단은 Redis에서 처리하고,  
  DB에는 발급 성공 이력(CouponIssue)만 저장
  
<img width="980" height="317" alt="image" src="https://github.com/user-attachments/assets/ea72d16e-8660-4c9f-a4b4-794b775a8848" />
---

## ⚡ 부하 테스트 (k6)

### 테스트 조건
- 시나리오: 한정 수량 선착순 쿠폰 발급
- 요청 방식: constant-arrival-rate (초당 일정한 요청 수 유지)
- 초당 요청 수: 약 2,800
- 테스트 시간: 60초
- 최대 VU: 3,000
- 한정 수량 쿠폰: 100,000

### 테스트 결과
- 총 요청 수(total_request): 113,286
- 발급 성공(sucess): 100,000
- 재고 부족(sold_out): 13,286
- 과발급: 0
- HTTP 실패: 0%
- 평균 응답 시간: 약 1.5초
- P95 응답 시간: 약 1.7초

10만 건 발급을 목표로 한 선착순 이벤트에서  
정확한 수량 보장과 안정적인 응답을 확인

<img width="592" height="369" alt="image" src="https://github.com/user-attachments/assets/f6604e03-1dfe-4691-9bf5-06a8788e3b92" />
---

## ✍️ 마무리
선착순 쿠폰 발급을 구현하면서 요청이 몰릴 때 어떤 문제가 생기는지,  
그리고 그 문제를 어떻게 안정적으로 막을 수 있는지 고민해볼 수 있었습니다.
